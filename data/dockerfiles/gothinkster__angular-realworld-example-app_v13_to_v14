# Base image: Node 18 LTS on Debian slim (Angular 13 supports Node 12.20.2+, 14.15.0+, or 16.10.0+)
FROM node:18-bookworm-slim@sha256:f9ab18e354e6855ae56ef2b290dd225c1e51a564f87584b9bd21dd651838830e

# Set environment variables for CI
ENV CI=true \
    TZ=UTC \
    LANG=C.UTF-8 \
    NG_CLI_ANALYTICS=false \
    NPM_CONFIG_AUDIT=false \
    NPM_CONFIG_FUND=false \
    CHROME_BIN=/usr/bin/chromium

# Install system packages needed for Angular CI
# - git: for repository cloning
# - ca-certificates: for SSL certificate verification
# - chromium and chromium-driver: for Angular testing with ChromeHeadless
RUN apt-get update && \
    apt-get install -y \
        curl \
        git \
        ca-certificates \
        chromium \
        chromium-driver \
        --no-install-recommends && \
    rm -rf /var/lib/apt/lists/* && \
    apt-get clean

# Create project directory and give ownership to non-root user
RUN mkdir -p /app/project && chown -R node:node /app

# Switch to non-root 'node' user for safer container execution
USER node

# Set working directory to the expected project path
WORKDIR /app/project

# Use a writable npm cache location for the non-root user
ENV NPM_CONFIG_CACHE=/home/node/.npm

# Download a history-free snapshot of the code at the specific commit (Angular 13)
RUN curl -L https://github.com/gothinkster/angular-realworld-example-app/archive/db8c6b0.tar.gz \
    | tar -xz --strip-components=1

# Mark the repo as safe to avoid Git ownership warnings, as we'll init it for the agent
RUN git init && git config --global --add safe.directory /app/project

# Default command - idle state for external harness
CMD ["bash", "-lc", "sleep infinity"]
