# Minimal test Dockerfile for unit/integration testing (Angular 16 to 17)
FROM node:18.19.0-bullseye-slim

# Set environment variables for CI
ENV CI=true \
    TZ=UTC \
    LANG=C.UTF-8 \
    NG_CLI_ANALYTICS=false \
    NPM_CONFIG_AUDIT=false \
    NPM_CONFIG_FUND=false \
    CHROME_BIN=/usr/bin/chromium

# Install minimal system packages for testing
RUN apt-get update && \
    apt-get install -y \
        git \
        ca-certificates \
        chromium \
        chromium-driver \
        --no-install-recommends && \
    rm -rf /var/lib/apt/lists/* && \
    apt-get clean

# Create project directory and give ownership to non-root user
RUN mkdir -p /app/project && chown -R node:node /app

# Switch to non-root 'node' user
USER node

# Set working directory
WORKDIR /app/project

# Use a writable npm cache location for the non-root user
ENV NPM_CONFIG_CACHE=/home/node/.npm

# For testing, create a minimal Angular project structure instead of cloning
RUN mkdir -p src/app && \
    echo '{"name": "test-project", "version": "1.0.0", "dependencies": {"@angular/core": "^16.0.0"}}' > package.json && \
    echo 'export class AppComponent { title = "test"; }' > src/app/app.component.ts

# Mark the directory as safe
RUN git init && git config --global --add safe.directory /app/project

# Default command - idle state for external harness
CMD ["bash", "-lc", "sleep infinity"]