# Base image: Node 18 LTS on Debian slim
FROM node:18-bookworm-slim

# Set environment variables for CI
ENV CI=true \
    TZ=UTC \
    LANG=C.UTF-8 \
    NG_CLI_ANALYTICS=false \
    NPM_CONFIG_AUDIT=false \
    NPM_CONFIG_FUND=false \
    CHROME_BIN=/usr/bin/chromium

# Install system packages needed for Angular CI
RUN apt-get update && apt-get install -y \
    git \
    chromium \
    chromium-driver \
    && rm -rf /var/lib/apt/lists/*

# Create project directory and give ownership to non-root user
RUN mkdir -p /app/project && chown -R node:node /app

# Switch to non-root 'node' user for safer container execution
USER node

# Set working directory to the expected project path
WORKDIR /app/project

# Use a writable npm cache location for the non-root user
ENV NPM_CONFIG_CACHE=/home/node/.npm

# Clone repository and checkout specific commit (Angular 15)
RUN git clone https://github.com/gothinkster/angular-realworld-example-app.git . && \
    git checkout e28c896

# Mark the repo as safe to avoid Git ownership warnings
RUN git config --global --add safe.directory /app/project

# Neutral idle command - do not run install/build/lint/test
CMD ["bash", "-lc", "sleep infinity"]